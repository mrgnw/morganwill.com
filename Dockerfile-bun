# Optimized Bun Dockerfile that avoids Cloudflare workerd issues
FROM node:25-alpine AS base
RUN npm install -g bun
WORKDIR /app

FROM base AS dev

# Copy package files
COPY package*.json bun.lockb* ./

# Install dependencies and add Node adapter for development compatibility
RUN bun install && \
    bun add @sveltejs/adapter-node --dev && \
    bun pm cache rm

# Create development-specific svelte config using Node adapter
COPY svelte.config.js svelte.config.js.backup
RUN sed 's/@sveltejs\/adapter-cloudflare/@sveltejs\/adapter-node/g' svelte.config.js.backup > svelte.config.js

# Copy configuration files
COPY vite.config.js jsconfig.json postcss.config.cjs tailwind.config.js components.json ./

# Copy source code and static files
COPY src ./src
COPY static ./static

# Generate SvelteKit files with Node adapter
RUN bunx svelte-kit sync

ENV NODE_ENV=development
ENV HOST=0.0.0.0
EXPOSE 5173

CMD ["bun", "run", "dev", "--host"]
